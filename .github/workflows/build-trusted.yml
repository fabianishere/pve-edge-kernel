name: Kernel Build (Trusted)

on: pull_request

jobs:
  build:
    name: Build
    runs-on: self-hosted
    if: github.event.pull_request.head.repo.full_name == github.repository && !contains(github.event.head_commit.message, 'skip ci')
    steps:
    - name: Clean Workspace
      run: rm -rf *.deb *.ddeb *.build *.buildinfo *.changes
    - name: Checkout Sources
      uses: actions/checkout@v2
      with:
          submodules: recursive
          path: pve-edge-kernel
    - name: Clean Repository
      run: git -C pve-edge-kernel submodule foreach git clean -ffdx
    - name: Build Kernel
      run: |
        rm -rf *.deb *.ddeb *.build *.buildinfo *.changes
        cd pve-edge-kernel
        debian/rules debian/control
        debuild -e CCACHE_DIR=/var/cache/ccache --prepend-path=/usr/lib/ccache --jobs=auto -b -uc -us
    - name: Upload Artifacts
      uses: actions/upload-artifact@v2-preview
      with:
        name: debs
        path: "*.deb"
